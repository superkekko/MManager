<?php include('header.html');

include('session.php');

include('action_admin.php');

include('action_categ.php');

//localization
include('../locale/'.$_SESSION['lang'].'.php');
setlocale(LC_ALL, 'ita');

//variables
$cur_yea = strftime("%Y");
$cur_month = strftime("%m");
$cur_user = $_SESSION['login_user'];
//get previous 6 months
for ($i = 5; $i >= 0; $i--) {
  $months[] = date("Y-n", strtotime( date( 'Y-n-01' )." -$i months"));
  $months_desc[] = ucwords(strftime('%B - %Y', strtotime(date("Y-m", strtotime( date( 'Y-m-01' )." -$i months")))));
}
$color = array("text-primary","text-success","text-info","text-warning","text-danger");

// get detail
$sql_query = "select mov_id, cat_name, val, dat_mov, usr_mov, note from mov";
$sql_exec = mysqli_query($db, $sql_query);
$val_det = array();
while($sql_row = mysqli_fetch_assoc($sql_exec)) {
    $val_det[]=$sql_row;
  };

$sql_query = "SELECT GROUP_CONCAT(CONCAT('\"',cat_name,'\"')) as category FROM cat";
$sql_exec = mysqli_query($db, $sql_query);
$sql_row = mysqli_fetch_array($sql_exec, MYSQLI_ASSOC);
$category = $sql_row['category'];

$sql_query = "SELECT GROUP_CONCAT(CONCAT('\"',usr_id,'\"')) as user FROM user";
$sql_exec = mysqli_query($db, $sql_query);
$sql_row = mysqli_fetch_array($sql_exec, MYSQLI_ASSOC);
$user = $sql_row['user'];
?>

<!-- Content Wrapper -->
<div id="content-wrapper" class="d-flex flex-column">

  <!-- Main Content -->
  <div id="content">

    <!-- Begin Page Content -->
    <div class="container-fluid">

      <!-- Page Heading -->
      <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Impostazioni | Admin</h1>
      </div>
          <!-- Content Row -->
          <div class="row">

            <!-- Content Column -->
            <div class="col-lg-12 mb-12">
              <!-- Project Card Example -->
              <div class="card shadow mb-12">
                <div class="card-header py-3">
                  <h6 class="m-0 font-weight-bold text-primary">Gestione utenti</h6>
                  <p style="text-align:right">
                    <a href="#" onclick="users.insertRow(1,0,true)" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i class="fas fa-plus fa-sm text-white-50"></i> Add row</a>
                    <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id='user_save'><i class="fas fa-save fa-sm text-white-50"></i> Save row(s)</a>
                    <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id='user_remove'><i class="fas fa-minus fa-sm text-white-50"></i> Delete selected row(s)</a>
                  </p>
                </div>
                <div class="card-body" id="table">
                  <div id="users_table"></div>
                </div>
              </div>
            </div>
        </div>
        <!-- /.container-fluid -->
        <br><br>
        <!-- Content Row -->
        <div class="row">
          <!-- Content Column -->
          <div class="col-lg-12 mb-12">
            <!-- Project Card Example -->
            <div class="card shadow mb-12">
              <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Gestione categorie</h6>
                <p style="text-align:right">
                  <a href="#" onclick="categ.insertRow(1,0,true)" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i class="fas fa-plus fa-sm text-white-50"></i> Add row</a>
                  <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id='categ_save'><i class="fas fa-save fa-sm text-white-50"></i> Save row(s)</a>
                  <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id='categ_remove'><i class="fas fa-minus fa-sm text-white-50"></i> Delete selected row(s)</a>
                </p>
              </div>
              <div class="card-body">
                <div id="categ_table"></div>
              </div>
            </div>
          </div>
      </div>
      <!-- /.container-fluid -->

        </div>
        <!-- /.container-fluid -->

      </div>
      <!-- End of Main Content -->

      <script src="movements/jsuites.js"></script>
      <script src="movements/jexcel.js"></script>
      <script src="movements/accounting.js"></script>

      <script>

      var myRequest = null;

      function CreateXmlHttpReq(handler) {
        var xmlhttp = null;
        xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = handler;
        return xmlhttp;
      }

      function myHandler() {
          if (myRequest.readyState == 4 && myRequest.status == 200) {
            console.log(myRequest.responseText);
            var resp = myRequest.responseText;
            var iniResp = resp.substring(0, 3);
             if (iniResp == 'ERR'){
               alert(resp);
             }
              users.refresh();
          }
      }

        var delDbRows = [];
        var delFeRows = [];
        var addFeRows = [];
        var addDbRows = [];
        var add = 0;
        var lastAction = true;
        var lastActionSave = false;
        var insertStart = false;

        document.getElementById('user_remove').onclick = function () {
          var first = true;
          delFeRows.forEach(function (item) {
            if (first){
              users.deleteRow(item);
              first = false;
            }else{
              users.deleteRow(item-1);
            }
            if (delDbRows !== " "){
              console.log(delDbRows);
              myRequest = CreateXmlHttpReq(myHandler);
              myRequest.open("POST","action_admin.php");
              myRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
              myRequest.send("pk="+delDbRows+"&action=delete");
            }
            users.getJson();
          })
        }

        document.getElementById('user_save').onclick = function () {
          addFeRows.forEach(function (item) {
            var row = 'A'.concat(item+1);
            users.setStyle(row, 'background-color', 'white');
            var row = 'B'.concat(item+1);
            users.setStyle(row, 'background-color', 'white');
            var row = 'C'.concat(item+1);
            users.setStyle(row, 'background-color', 'white');
            var row = 'D'.concat(item+1);
            users.setStyle(row, 'background-color', 'white');
            var row = 'E'.concat(item+1);
            users.setStyle(row, 'background-color', 'white');
            var row = 'F'.concat(item+1);
            users.setStyle(row, 'background-color', 'white');
            addDbRows[item] = users.getRowData(item);
            //console.log('A'.concat(item+1));
          })
          console.log(addDbRows);
          var usrId = addDbRows[0][0];
          var email = addDbRows[0][1];
          var password = addDbRows[0][2];
          var admin = addDbRows[0][4];
          var valid = addDbRows[0][5];
          var color = addDbRows[0][6];
          myRequest = CreateXmlHttpReq(myHandler);
          myRequest.open("POST","action_admin.php");
          myRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
          myRequest.send("usrid="+usrId+"&email="+email+"&password="+password+"&admin="+admin+"&valid="+valid+"&color="+color+"&action=save");
          addFeRows = [];
          add = 0;
          lastActionSave = true;
          lastAction = true;
          insertStart = false;
        }

        var windowDimension = window.innerWidth;
        var sidebarDimension = document.getElementById("accordionSidebar").offsetWidth;
        console.log(windowDimension, sidebarDimension);
        var tableDimension = windowDimension - sidebarDimension - 170
        var emailDimension = tableDimension - 900;
        var textDimension = tableDimension - 550;
        
        function refreshtable(){
        var windowDimension = window.innerWidth;
        var sidebarDimension = document.getElementById("accordionSidebar").offsetWidth;
        if (sidebarDimension == 224){
          sidebarDimension = 104;
        }else{
          sidebarDimension = 224;
        }
        console.log(windowDimension, sidebarDimension);
        var tableDimension = windowDimension - sidebarDimension - 170
        var emailDimension = tableDimension - 900;
        users.setWidth(1, emailDimension);
        var textDimension = tableDimension - 550;
        categ.setWidth(6, textDimension);
        }

        window.addEventListener("resize", refreshtable);

        var users = jexcel(document.getElementById('users_table'), {
            url:'results_user.json',
            search:true,
            //pagination:true,
            //pagination:50,
            //tableOverflow:true,
            //lazyLoading:true,
            //loadingSpin:true,
            tableWidth: tableDimension,
            tableHeight: '700px',
            defaultColWidth: 150,
            contextMenu: false,
            //filters:true,
            includeHeadersOnDownload:true,
            csvFileName:'movements',
            columns: [
                {
                    type: 'text',
                    title:'login',
                    width:150
                },
                {
                    type: 'text',
                    title:'email',
                    width: emailDimension
                },
                {
                    type: 'text',
                    title:'password',
                    width: 150
                },
                {
                    type: 'calendar',
                    title:'last_login',
                    readOnly:true,
                    width:150
                },
                {
                    type: 'checkbox',
                    title:'admin',
                    width:150
                },
                {
                    type: 'checkbox',
                    title:'valid',
                    width:150
                },
                {
                    type: 'color',
                    title:'color',
                    render:'square',
                    width:150
                },
             ],
          onchange: function(el,cell,colNumber,rowNumber,value,old_value) {
            lastActionSave = false;
            var row_data = users.getRowData(rowNumber);
            var row_pk = row_data[0];
            if (!insertStart){
              console.log(row_pk,colNumber,value);
              myRequest = CreateXmlHttpReq(myHandler);
              myRequest.open("POST","action_admin.php");
              myRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
              myRequest.send("pk="+row_pk+"&col="+colNumber+"&value="+value+"&action=edit");
              lastAction = true;
            }
          },
          onselection: function(instance,colNumber1,rowNumber1,colNumber2,rowNumber2) {
            delDbRows = [];
            delFeRows = [];
            for(let i=rowNumber1;i<=rowNumber2;i++)
            {
                var row_data = users.getRowData(i);
                var row_pk = row_data[0];
                delDbRows.push(row_pk);
                delFeRows.push(i);
            }
            //console.log(rowNumber1, rowNumber2, delDbRows, delFeRows);
          },
          onundo: function(el,value) {
            console.log(value);
            if(undo.action == 'deleteRow'){
              console.log(value.action, value.rowData[0]);
            }else if (value.action == 'setValue'){
              console.log(value.action, undo.records[0].col, value.records[0].row, value.records[0].oldValue);
            }
          },
          oninsertrow: function(el, rowNumber, numOfRows, rowRecords, insertBefore) {
            lastActionSave = false;
            addFeRows.push(add);
            users.setStyle({ A1:'background-color: #eee;', B1:'background-color: #eee;', C1:'background-color: #eee;', D1:'background-color: #eee;', E1:'background-color: #eee;', F1:'background-color: #eee;' });
            add++;
            lastAction = true;
            insertStart = true;
            //console.log(addFeRows);
          }
        });

//gestione categorie

        document.getElementById('categ_remove').onclick = function () {
          var first = true;
          delFeRows.forEach(function (item) {
            if (first){
              categ.deleteRow(item);
              first = false;
            }else{
              categ.deleteRow(item-1);
            }
            if (delDbRows !== " "){
              console.log(delDbRows);
              myRequest = CreateXmlHttpReq(myHandler);
              myRequest.open("POST","action_categ.php");
              myRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
              myRequest.send("pk="+delDbRows+"&action=delete");
            }
            users.getJson();
          })
        }

        document.getElementById('categ_save').onclick = function () {
          addFeRows.forEach(function (item) {
            var row = 'A'.concat(item+1);
            categ.setStyle(row, 'background-color', 'white');
            var row = 'B'.concat(item+1);
            categ.setStyle(row, 'background-color', 'white');
            var row = 'C'.concat(item+1);
            categ.setStyle(row, 'background-color', 'white');
            var row = 'D'.concat(item+1);
            categ.setStyle(row, 'background-color', 'white');
            var row = 'E'.concat(item+1);
            categ.setStyle(row, 'background-color', 'white');
            var row = 'F'.concat(item+1);
            categ.setStyle(row, 'background-color', 'white');
            addDbRows[item] = users.getRowData(item);
            //console.log('A'.concat(item+1));
          })
          console.log(addDbRows);
          var usrId = addDbRows[0][0];
          var email = addDbRows[0][1];
          var password = addDbRows[0][2];
          var admin = addDbRows[0][4];
          var valid = addDbRows[0][5];
          var color = addDbRows[0][6];
          myRequest = CreateXmlHttpReq(myHandler);
          myRequest.open("POST","action_categ.php");
          myRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
          myRequest.send("usrid="+usrId+"&email="+email+"&password="+password+"&admin="+admin+"&valid="+valid+"&color="+color+"&action=save");
          addFeRows = [];
          add = 0;
          lastActionSave = true;
          lastAction = true;
          insertStart = false;
        }

        var categ = jexcel(document.getElementById('categ_table'), {
            url:'results_cat.json',
            search:true,
            //pagination:true,
            //pagination:50,
            tableOverflow:true,
            lazyLoading:true,
            loadingSpin:true,
            tableWidth: tableDimension,
            tableHeight: '700px',
            defaultColWidth: 150,
            contextMenu: false,
            //filters:true,
            includeHeadersOnDownload:true,
            csvFileName:'movements',
            columns: [
                {
                    type: 'hidden',
                    title:'id',
                    //width:150
                },
                {
                    type: 'text',
                    title:'name',
                    width: 150
                },
                {
                    type: 'text',
                    title:'parent',
                    width: 150
                },
                {
                    type: 'checkbox',
                    title:'income',
                    width: 100
                },
                {
                    type: 'numeric',
                    title:'movements',
                    width: 100
                },
                {
                    type: 'color',
                    title:'color',
                    render:'square',
                    width: 50
                },
                {
                    type: 'text',
                    title: 'keyword',
                    align: 'left',
                    width: textDimension
                },
             ],
          onchange: function(el,cell,colNumber,rowNumber,value,old_value) {
            lastActionSave = false;
            var row_data = categ.getRowData(rowNumber);
            var row_pk = row_data[0];
            if (!insertStart){
              console.log(row_pk,colNumber,value);
              myRequest = CreateXmlHttpReq(myHandler);
              myRequest.open("POST","action_categ.php");
              myRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
              myRequest.send("pk="+row_pk+"&col="+colNumber+"&value="+value+"&action=edit");
              lastAction = true;
            }
          },
          onselection: function(instance,colNumber1,rowNumber1,colNumber2,rowNumber2) {
            delDbRows = [];
            delFeRows = [];
            for(let i=rowNumber1;i<=rowNumber2;i++)
            {
                var row_data = categ.getRowData(i);
                var row_pk = row_data[0];
                delDbRows.push(row_pk);
                delFeRows.push(i);
            }
            //console.log(rowNumber1, rowNumber2, delDbRows, delFeRows);
          },
          onundo: function(el,value) {
            console.log(value);
            if(undo.action == 'deleteRow'){
              console.log(value.action, value.rowData[0]);
            }else if (value.action == 'setValue'){
              console.log(value.action, undo.records[0].col, value.records[0].row, value.records[0].oldValue);
            }
          },
          oninsertrow: function(el, rowNumber, numOfRows, rowRecords, insertBefore) {
            lastActionSave = false;
            addFeRows.push(add);
            categ.setStyle({ A1:'background-color: #eee;', B1:'background-color: #eee;', C1:'background-color: #eee;', D1:'background-color: #eee;', E1:'background-color: #eee;', F1:'background-color: #eee;' });
            add++;
            lastAction = true;
            insertStart = true;
            //console.log(addFeRows);
          }
        });
      </script>

<?php include('footer.html'); ?>

</body>

</html>
