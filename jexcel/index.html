<?php

include('action.php');

include('../session.php');

//localization
include('../locale/'.$_SESSION['lang'].'.php');
setlocale(LC_ALL, 'ita');

//variables
$cur_yea = strftime("%Y");
$cur_month = strftime("%m");
$cur_user = $_SESSION['login_user'];
//get previous 6 months
for ($i = 5; $i >= 0; $i--) {
  $months[] = date("Y-n", strtotime( date( 'Y-n-01' )." -$i months"));
  $months_desc[] = ucwords(strftime('%B - %Y', strtotime(date("Y-m", strtotime( date( 'Y-m-01' )." -$i months")))));
}
$color = array("text-primary","text-success","text-info","text-warning","text-danger");

// get detail
$sql_query = "select mov_id, cat_name, val, dat_mov, usr_mov, note from mov";
$sql_exec = mysqli_query($db, $sql_query);
$val_det = array();
while($sql_row = mysqli_fetch_assoc($sql_exec)) {
    $val_det[]=$sql_row;
  };

$sql_query = "SELECT GROUP_CONCAT(CONCAT('\"',cat_name,'\"')) as category FROM cat";
$sql_exec = mysqli_query($db, $sql_query);
$sql_row = mysqli_fetch_array($sql_exec, MYSQLI_ASSOC);
$category = $sql_row['category'];

$sql_query = "SELECT GROUP_CONCAT(CONCAT('\"',usr_id,'\"')) as user FROM user";
$sql_exec = mysqli_query($db, $sql_query);
$sql_row = mysqli_fetch_array($sql_exec, MYSQLI_ASSOC);
$user = $sql_row['user'];
?>

<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Jexcel es</title>

  <!-- Custom fonts for this template-->
  <link href="../vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">

  <link rel="stylesheet" href="jexcel.css" type="text/css" />
  <link rel="stylesheet" href="jsuites.css" type="text/css" />
  <link rel="stylesheet" href="jexcel.datatables.css" type="text/css" />

  <!-- Custom styles for this template-->
  <link href="../css/sb-admin-2.min.css" rel="stylesheet">

</head>

<body>

  <script src="jsuites.js"></script>
  <script src="jexcel.js"></script>
  <script src="accounting.js"></script>

<div id="spreadsheet"></div>

<div>
<a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id='download'><i class="fas fa-download fa-sm text-white-50"></i> Download</a>
<a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id='undo'><i class="fas fa-undo fa-sm text-white-50"></i> Undo</a>
<a href="#" onclick="mySpreadsheet.insertRow(1,0,true)" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i class="fas fa-plus fa-sm text-white-50"></i> Add row</a>
<a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id='save'><i class="fas fa-save fa-sm text-white-50"></i> Save row(s)</a>
<a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id='remove'><i class="fas fa-minus fa-sm text-white-50"></i> Delete selected row(s)</a>
</div>

<script>

var myRequest = null;

function CreateXmlHttpReq(handler) {
  var xmlhttp = null;
  xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = handler;
  return xmlhttp;
}

function myHandler() {
    if (myRequest.readyState == 4 && myRequest.status == 200) {
        console.log(myRequest.responseText);
        mySpreadsheet.refresh();
    }
}

  var delDbRows = [];
  var delFeRows = [];
  var addFeRows = [];
  var addDbRows = [];
  var add = 0;
  var lastAction = true;
  var lastActionSave = false;
  var insertStart = false;
  var value;

  document.getElementById('undo').onclick = function () {
    if(lastAction){
      if(!lastActionSave){
        mySpreadsheet.undo();
      }else{
        console.log(addDbRows);
        for(let i=1;i<=addDbRows.length;i++)
        {
          mySpreadsheet.deleteRow(0);
        }
        lastActionSave = false;
      }
    }
    lastAction = false;
  }

  document.getElementById('download').onclick = function () {
      mySpreadsheet.download(false);
  }

  document.getElementById('remove').onclick = function () {
    var first = true;
    delFeRows.forEach(function (item) {
      if (first){
        mySpreadsheet.deleteRow(item);
        first = false;
      }else{
        mySpreadsheet.deleteRow(item-1);
      }
      if (delDbRows !== " "){
        console.log(delDbRows);
      }
      mySpreadsheet.getJson();
    })
  }

  document.getElementById('save').onclick = function () {
    addFeRows.forEach(function (item) {
      var row = 'A'.concat(item+1);
      mySpreadsheet.setStyle(row, 'background-color', 'white');
      var row = 'B'.concat(item+1);
      mySpreadsheet.setStyle(row, 'background-color', 'white');
      var row = 'C'.concat(item+1);
      mySpreadsheet.setStyle(row, 'background-color', 'white');
      var row = 'D'.concat(item+1);
      mySpreadsheet.setStyle(row, 'background-color', 'white');
      var row = 'E'.concat(item+1);
      mySpreadsheet.setStyle(row, 'background-color', 'white');
      var row = 'F'.concat(item+1);
      mySpreadsheet.setStyle(row, 'background-color', 'white');
      addDbRows[item] = mySpreadsheet.getRowData(item);
      //console.log('A'.concat(item+1));
    })
    console.log(addDbRows);
    addFeRows = [];
    add = 0;
    lastActionSave = true;
    lastAction = true;
    insertStart = false;
  }

  var mySpreadsheet = jexcel(document.getElementById('spreadsheet'), {
      url:'results.json',
      search:true,
      pagination:25,
      contextMenu: false,
      columns: [
          {
              type: 'hidden',
              title:'ID',
              width:150
          },
          {
              type: 'dropdown',
              title:'Categoria',
              source:[<?php echo $category; ?>],
              width:150
          },
          {
              type: 'numeric',
              title:'Valore',
              mask:'[-]â‚¬ #.##,00',
              width:100,
              decimal:','
          },
          {
              type: 'calendar',
              options: { format:'DD/MM/YYYY' },
              title:'Data',
              width:120
          },
          {
              type: 'dropdown',
              title:'Utente',
              source:[<?php echo $user; ?>],
              width:90
          },
          {
              type: 'text',
              title:'Note',
              width:200
          },
       ],
    onchange: function(el,cell,colNumber,rowNumber,value,old_value) {
      lastActionSave = false;
      var row_data = mySpreadsheet.getRowData(rowNumber);
      var row_pk = row_data[0];
      if(colNumber == 2){
        value=accounting.unformat(value, ",");
      }
      if (row_pk !== ""){
        console.log(row_pk,colNumber,value);
      }
      if (!insertStart){
        myRequest = CreateXmlHttpReq(myHandler);
        myRequest.open("POST","action.php");
        myRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
	      myRequest.send("pk="+row_pk+"&col="+colNumber+"&value="+value+"&action=edit");
        lastAction = true;
      }
    },
    onselection: function(instance,colNumber1,rowNumber1,colNumber2,rowNumber2) {
      delDbRows = [];
      delFeRows = [];
      for(let i=rowNumber1;i<=rowNumber2;i++)
      {
          var row_data = mySpreadsheet.getRowData(i);
          var row_pk = row_data[0];
		      delDbRows.push(row_pk);
          delFeRows.push(i);
	    }
      //console.log(rowNumber1, rowNumber2, delDbRows, delFeRows);
    },
    onundo: function(el,value) {
      //console.log(value);
      if(value.action == 'deleteRow'){
        console.log(value.action, value.rowData[0]);
      }else if (value.action == 'setValue'){
        console.log(value.action, value.records[0].col, value.records[0].row, value.records[0].oldValue);
      }
    },
    oninsertrow: function(el, rowNumber, numOfRows, rowRecords, insertBefore) {
      lastActionSave = false;
      addFeRows.push(add);
      mySpreadsheet.setStyle({ A1:'background-color: #eee;', B1:'background-color: #eee;', C1:'background-color: #eee;', D1:'background-color: #eee;', E1:'background-color: #eee;', F1:'background-color: #eee;' });
      add++;
      lastAction = true;
      insertStart = true;
      //console.log(addFeRows);
    }
  });

</script>

</body>
</html>
