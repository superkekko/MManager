<?php
error_log('problem!');
include('header.html');
include('session.php');
include('action.php');

if (file_exists('upload.log')) {
  header('Content-Description: File Transfer');
  header('Content-Type: application/octet-stream');
  header('Content-Disposition: attachment; filename="'.basename('upload.log').'"');
  header('Expires: 0');
  header('Cache-Control: must-revalidate');
  header('Pragma: public');
  header('Content-Length: ' . filesize('upload.log'));
  readfile('upload.log');
  unlink('upload.log');
  exit;
}

if (file_exists('import.log')) {
  header('Content-Description: File Transfer');
  header('Content-Type: application/octet-stream');
  header('Content-Disposition: attachment; filename="'.basename('import.log').'"');
  header('Expires: 0');
  header('Cache-Control: must-revalidate');
  header('Pragma: public');
  header('Content-Length: ' . filesize('import.log'));
  readfile('import.log');
  unlink('import.log');
  exit;
}

if(isset($_FILES['file']['tmp_name'])) {
  if(is_uploaded_file($_FILES['file']['tmp_name'])) {
    $err=0;
    $file = $_FILES['file']['tmp_name'];
    $handle = fopen($file, "r");
    $c = 0;
    $i = 0;

    $sql_del = "delete from importcsv";
    mysqli_query($db, $sql_del);

    while(($filesop = fgetcsv($handle, 1000, ";")) !== false) {
      $dat_mov = mysqli_real_escape_string($db, $filesop[0]);
      $description = mysqli_real_escape_string($db, $filesop[1]);
      $value = str_replace('.', '', mysqli_real_escape_string($db, $filesop[2]));

      if ($i>0){
        $sql_file = "INSERT INTO importcsv (dat_mov, description, value, usr_mov) VALUES ('$dat_mov', '$description', '$value', '$user')";
        $result_sql = mysqli_query($db, $sql_file);
        if (!$result_sql){
          if ($err==0){
            $filename='upload.log';
            $log = "Upload log ".date('d/m/Y h:m:s')."\n";
            $err = 1;
          }
          $log .= "not loaded (".mysqli_error($db)."): ".$dat_mov." | ".$description." | ".$value."\n";
        }
      }
      $i=$i+1;
      if ($err==1){
        file_put_contents($filename, $log);
      }
    }
    $sql_file = "CALL csv_import()";
    mysqli_query($db, $sql_file);

    $sql_ver = "select * from importcsv c where c.mov_imp = ''";
    $result_ver = mysqli_query($db, $sql_ver);
    $count      = mysqli_num_rows($result_ver);
    echo $count;
    if ($count > 0){
      $filename_imp='import.log';
      $imp = "Import log ".date('d/m/Y h:m:s')."\n";
      while ($res_usr = mysqli_fetch_array($result_ver, MYSQLI_ASSOC)){
        $imp .= "not imported: ".$res_usr['dat_mov']." | ".$res_usr['description']." | ".$res_usr['value']."\n";
      }
      file_put_contents($filename_imp, $imp);
    }
    echo '<META HTTP-EQUIV="Refresh" Content="0; URL=movements.html">';
    }
  }

//localization
include('../locale/'.$_SESSION['lang'].'.php');
setlocale(LC_ALL, 'ita');

//variables
$cur_yea = strftime("%Y");
$cur_month = strftime("%m");
$cur_user = $_SESSION['login_user'];
//get previous 6 months
for ($i = 5; $i >= 0; $i--) {
  $months[] = date("Y-n", strtotime( date( 'Y-n-01' )." -$i months"));
  $months_desc[] = ucwords(strftime('%B - %Y', strtotime(date("Y-m", strtotime( date( 'Y-m-01' )." -$i months")))));
}
$color = array("text-primary","text-success","text-info","text-warning","text-danger");

// get detail
$sql_query = "select mov_id, cat_name, val, dat_mov, usr_mov, note from mov";
$sql_exec = mysqli_query($db, $sql_query);
$val_det = array();
while($sql_row = mysqli_fetch_assoc($sql_exec)) {
    $val_det[]=$sql_row;
  };

$sql_query = "SELECT GROUP_CONCAT(CONCAT('\"',cat_name,'\"')) as category FROM cat";
$sql_exec = mysqli_query($db, $sql_query);
$sql_row = mysqli_fetch_array($sql_exec, MYSQLI_ASSOC);
$category = $sql_row['category'];

$sql_query = "SELECT GROUP_CONCAT(CONCAT('\"',usr_id,'\"')) as user FROM user";
$sql_exec = mysqli_query($db, $sql_query);
$sql_row = mysqli_fetch_array($sql_exec, MYSQLI_ASSOC);
$user = $sql_row['user'];
?>

<!-- Logout Modal-->
<div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Seleziona un file csv da caricare</h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <form name="upload" method="post" action="movements.html" role="form" enctype="multipart/form-data">
      <div class="modal-body">
        <div class="custom-file">
          <input type="file" name="file" class="custom-file-input" id="customFile" required>
          <label class="custom-file-label" for="customFile">Seleziona un file...</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
        <input type="submit" name="submit" value="Carica" class="btn btn-primary">
      </div>
    </form>
    </div>
  </div>
</div>

<!-- <div class="modal-body">
  <form name="upload" method="post" action="movements.html" role="form" enctype="multipart/form-data">
  <div class="col-8 custom-file">
    <input type="file" class="custom-file-input" id="customFile" required>
    <label class="custom-file-label" for="customFile">Seleziona un file...</label>
  </div>
  <div class="col-2 custom-file">
    <input type="submit" name="submit" value="Carica" class="btn btn-primary">
  </div>
</form>
</div> -->

        <!-- Begin Page Content -->
        <div class="container-fluid">

          <!-- Page Heading -->
          <h1 class="h3 mb-2 text-gray-800">Movements</h1>
          <p class="mb-4" style="text-align:right">
            <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id='upload'data-toggle="modal" data-target="#uploadModal"><i class="fas fa-upload fa-sm text-white-50"></i> Upload</a>
            <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id='download'><i class="fas fa-download fa-sm text-white-50"></i> Download</a>
            <!-- <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id='undo'><i class="fas fa-undo fa-sm text-white-50"></i> Undo</a> -->
            <a href="#" onclick="mySpreadsheet.insertRow(1,0,true)" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i class="fas fa-plus fa-sm text-white-50"></i> Add row</a>
            <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id='save'><i class="fas fa-save fa-sm text-white-50"></i> Save row(s)</a>
            <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id='remove'><i class="fas fa-minus fa-sm text-white-50"></i> Delete selected row(s)</a>
          </p>

          <!-- DataTales Example -->
          <div class="card shadow mb-4">
            <div id="table" class="card-body">
             <div id="spreadsheet"></div>
            </div>
          </div>

        </div>
        <!-- /.container-fluid -->

      </div>
      <!-- End of Main Content -->

      <script src="movements/jsuites.js"></script>
      <script src="movements/jexcel.js"></script>
      <script src="movements/accounting.js"></script>

      <script>

      var myRequest = null;

      function CreateXmlHttpReq(handler) {
        var xmlhttp = null;
        xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = handler;
        return xmlhttp;
      }

      function myHandler() {
          if (myRequest.readyState == 4 && myRequest.status == 200) {
              console.log(myRequest.responseText);
              mySpreadsheet.refresh();
          }
      }

        var delDbRows = [];
        var delFeRows = [];
        var addFeRows = [];
        var addDbRows = [];
        var add = 0;
        var lastAction = true;
        var lastActionSave = false;
        var insertStart = false;

        /* document.getElementById('undo').onclick = function () {
          if(lastAction){
            if(!lastActionSave){
              mySpreadsheet.undo();
            }else{
              console.log(addDbRows);
              for(let i=1;i<=addDbRows.length;i++)
              {
                mySpreadsheet.deleteRow(0);
              }
              lastActionSave = false;
            }
          }
          lastAction = false;
        }*/

        document.getElementById('download').onclick = function () {
            mySpreadsheet.download(false);
        }

        document.getElementById('remove').onclick = function () {
          var first = true;
          delFeRows.forEach(function (item) {
            if (first){
              mySpreadsheet.deleteRow(item);
              first = false;
            }else{
              mySpreadsheet.deleteRow(item-1);
            }
            if (delDbRows !== " "){
              console.log(delDbRows);
              myRequest = CreateXmlHttpReq(myHandler);
              myRequest.open("POST","action.php");
              myRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
              myRequest.send("pk="+delDbRows+"&action=delete");
            }
            mySpreadsheet.getJson();
          })
        }

        document.getElementById('save').onclick = function () {
          addFeRows.forEach(function (item) {
            var row = 'A'.concat(item+1);
            mySpreadsheet.setStyle(row, 'background-color', 'white');
            var row = 'B'.concat(item+1);
            mySpreadsheet.setStyle(row, 'background-color', 'white');
            var row = 'C'.concat(item+1);
            mySpreadsheet.setStyle(row, 'background-color', 'white');
            var row = 'D'.concat(item+1);
            mySpreadsheet.setStyle(row, 'background-color', 'white');
            var row = 'E'.concat(item+1);
            mySpreadsheet.setStyle(row, 'background-color', 'white');
            var row = 'F'.concat(item+1);
            mySpreadsheet.setStyle(row, 'background-color', 'white');
            addDbRows[item] = mySpreadsheet.getRowData(item);
            //console.log('A'.concat(item+1));
          })
          console.log(addDbRows);
          var cat = addDbRows[0][1];
          var curr = accounting.unformat(addDbRows[0][2], ",");
          var date = addDbRows[0][3];
          var usr = addDbRows[0][4];
          var note = addDbRows[0][5];
          myRequest = CreateXmlHttpReq(myHandler);
          myRequest.open("POST","action.php");
          myRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
          myRequest.send("cat="+cat+"&value="+curr+"&date="+date+"&usr="+usr+"&note="+note+"&action=save");
          addFeRows = [];
          add = 0;
          lastActionSave = true;
          lastAction = true;
          insertStart = false;
        }

        var divDimension = document.getElementById("table").offsetWidth;
        //sidebar aperta
        console.log(divDimension);
        divDimension = divDimension - 120
        var noteDimension = divDimension - 620;

        var mySpreadsheet = jexcel(document.getElementById('spreadsheet'), {
            url:'results.json',
            search:true,
            //pagination:true,
            //pagination:50,
            tableOverflow:true,
            lazyLoading:true,
            loadingSpin:true,
            tableWidth: divDimension,
            tableHeight: '500px',
            defaultColWidth: 150,
            contextMenu: false,
            //filters:true,
            includeHeadersOnDownload:true,
            csvFileName:'movements',
            columns: [
                {
                    type: 'hidden',
                    title:'ID',
                    //width:150
                },
                {
                    type: 'dropdown',
                    title:'Categoria',
                    source:[<?php echo $category; ?>],
                    autocomplete: true,
                    width:200
                },
                {
                    type: 'numeric',
                    title:'Valore',
                    mask:'[-]€ #.##,00',
                    width:150,
                    decimal:','
                },
                {
                    type: 'calendar',
                    options: { format:'DD/MM/YYYY' },
                    title:'Data',
                    width:120
                },
                {
                    type: 'dropdown',
                    title:'Utente',
                    source:[<?php echo $user; ?>],
                    autocomplete: true,
                    width:150
                },
                {
                    type: 'text',
                    title:'Note',
                    width:noteDimension,
                    align: 'left'
                },
             ],
          onchange: function(el,cell,colNumber,rowNumber,value,old_value) {
            lastActionSave = false;
            var row_data = mySpreadsheet.getRowData(rowNumber);
            var row_pk = row_data[0];
            if(colNumber == 2){
              var val=accounting.unformat(value, ",");
            }else{
              var val = value;
            }
            if (row_pk !== ""){
              console.log(row_pk,colNumber,value);
            }
            if (!insertStart){
              myRequest = CreateXmlHttpReq(myHandler);
              myRequest.open("POST","action.php");
              myRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      	      myRequest.send("pk="+row_pk+"&col="+colNumber+"&value="+val+"&action=edit");
              lastAction = true;
            }
          },
          onselection: function(instance,colNumber1,rowNumber1,colNumber2,rowNumber2) {
            delDbRows = [];
            delFeRows = [];
            for(let i=rowNumber1;i<=rowNumber2;i++)
            {
                var row_data = mySpreadsheet.getRowData(i);
                var row_pk = row_data[0];
      		      delDbRows.push(row_pk);
                delFeRows.push(i);
      	    }
            //console.log(rowNumber1, rowNumber2, delDbRows, delFeRows);
          },
          onundo: function(el,value) {
            console.log(value);
            if(undo.action == 'deleteRow'){
              console.log(value.action, value.rowData[0]);
            }else if (value.action == 'setValue'){
              console.log(value.action, undo.records[0].col, value.records[0].row, value.records[0].oldValue);
            }
          },
          oninsertrow: function(el, rowNumber, numOfRows, rowRecords, insertBefore) {
            lastActionSave = false;
            addFeRows.push(add);
            mySpreadsheet.setStyle({ A1:'background-color: #eee;', B1:'background-color: #eee;', C1:'background-color: #eee;', D1:'background-color: #eee;', E1:'background-color: #eee;', F1:'background-color: #eee;' });
            add++;
            lastAction = true;
            insertStart = true;
            //console.log(addFeRows);
          }
        });
      </script>

<?php include('footer.html'); ?>

</body>

</html>
